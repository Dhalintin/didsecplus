generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum Role {
  superAdmin
  admin
  citizen
}

enum Status {
  active
  investigating
  resolved
}

enum Source {
  phone
  app
  web
}

enum TicketStatus {
  open
  in_progress
  resolved
}

enum Priority {
  high
  mid
  low
}

enum Device {
  Android
  iOS
  Web
  Unknown
}

model User {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId
  email             String    @unique
  username          String?   
  name              String?   
  password          String
  phone             String?
  role              Role
  location          String?   
  device            Device?   
  created_at        DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  tickets           Ticket[]  @relation("UserTickets")
  alerts            Alert[]   @relation("UserAlert") // Added opposite relation
}

model Alert {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId
  userId            String?   @db.ObjectId // Made optional for onDelete: SetNull
  user              User?     @relation("UserAlert", fields: [userId], references: [id], onDelete: SetNull)
  title             String
  description       String?
  status            Status    @default(active)
  source            Source
  latitude          Float     
  longitude         Float     
  state             String
  lga               String
  assigned_unit     String?
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt
  tickets           Ticket[]  @relation("AlertTicket")

  @@index([userId])
  @@index([status])
  @@index([state])
}

model Ticket {
  id                String          @id @default(auto()) @map("_id") @db.ObjectId
  alert_Id          String          @unique @db.ObjectId
  alert             Alert           @relation("AlertTicket", fields: [alert_Id], references: [id], onDelete: Cascade)
  created_by        String?         @db.ObjectId
  user              User?           @relation("UserTickets", fields: [created_by], references: [id], onDelete: SetNull)
  title             String
  description       String?
  status            TicketStatus    @default(open)
  priority          Priority        @default(low)
  assigned_to       String?
  created_at        DateTime        @default(now())
  updated_at        DateTime        @updatedAt
  note              String?

  @@index([created_at])
  @@index([created_by])
}

model State {
  id        String    @id @map("_id")
  name      String
  capital   String
  centroid  Json      // Array of [latitude, longitude] in WGS84, e.g., [5.4527, 7.5248]
  lgas      Lga[]     @relation("StateLga")
}

model Lga {
  id        String    @id @map("_id")
  name      String
  stateId   String
  state     State     @relation("StateLga", fields: [stateId], references: [id], onDelete: Cascade)
  geometry  Json      // GeoJSON Polygon with [longitude, latitude] in WGS84
  @@index([stateId])
}