generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum Role {
  superAdmin
  admin
  citizen
}

enum Status {
  active
  investigating
  resolved
}

enum Source {
  phone
  app
  web
}

enum TicketStatus {
  open
  in_progress
  resolved
}

enum Priority {
  high
  mid
  low
}

enum Device {
  Android
  iOS
  Web
  Unknown
}

model User {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId
  email             String    @unique
  username          String?   
  name              String?   
  password          String
  phone             String?
  role              Role
  location          String?   
  device            Device?   
  created_at        DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  isVerified        Boolean   @default(false)
  
  tickets           Ticket[]  @relation("UserTickets")
  alerts            Alert[]   @relation("UserAlert")  
  
  verificationCodes VerificationCode[]
  receivedAlerts    AlertRecipient[]

  contacts Contact[] @relation("UserContacts")
  contactOf Contact[] @relation("UserContactOf")

  ticketChanges   TicketHistory[]  @relation("TicketHistoryChangedBy")
  alertChanges    AlertHistory[]   @relation("AlertHistoryChangedBy")
}

model Alert {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId
  userId            String?   @db.ObjectId
  user              User?     @relation("UserAlert", fields: [userId], references: [id], onDelete: SetNull)
  title             String
  description       String?
  status            Status    @default(active)
  source            Source
  latitude          Float     
  longitude         Float     
  state             String
  lga               String
  assigned_unit     String?
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt
  tickets           Ticket[]  @relation("AlertTicket")
  
  recipients        AlertRecipient[]
  history           AlertHistory[]

  @@index([userId])
  @@index([status])
  @@index([state])
}

model Ticket {
  id                String          @id @default(auto()) @map("_id") @db.ObjectId
  alert_Id          String          @unique @db.ObjectId
  alert             Alert           @relation("AlertTicket", fields: [alert_Id], references: [id], onDelete: Cascade)
  created_by        String?         @db.ObjectId
  user              User?           @relation("UserTickets", fields: [created_by], references: [id], onDelete: SetNull)
  title             String
  description       String?
  status            TicketStatus    @default(open)
  priority          Priority        @default(low)
  assigned_to       String?
  created_at        DateTime        @default(now())
  updated_at        DateTime        @updatedAt
  note              String?
  history           TicketHistory[]

  @@index([created_at])
  @@index([created_by])
  @@index([status])
}

model State {
  id        String    @id @map("_id")
  name      String    @unique
  capital   String
  centroid  Json      
  lgas      Lga[]     @relation("StateLga")
}

model Lga {
  id        String    @id @map("_id")
  name      String
  stateId   String
  state     State     @relation("StateLga", fields: [stateId], references: [id], onDelete: Cascade)
  geometry  Json      // GeoJSON Polygon with [longitude, latitude] in WGS84
  @@index([stateId])
}

enum VerificationCodeType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
}

model VerificationCode {
  id          String                @id @default(auto()) @map("_id") @db.ObjectId
  userId      String                @db.ObjectId
  user        User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  code        String
  type        VerificationCodeType  @default(EMAIL_VERIFICATION)
  expiresAt   DateTime
  used        Boolean               @default(false)
  createdAt   DateTime              @default(now())

  @@index([userId])
  @@index([code])
  @@index([expiresAt])
}

model AlertRecipient {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  alertId    String   @db.ObjectId
  userId     String   @db.ObjectId

  alert      Alert    @relation(fields: [alertId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)     
  seen       Boolean  @default(false)
  seenAt     DateTime?

  @@unique([alertId, userId])
  @@index([alertId])
  @@index([userId])
}

model TicketStatusSummary {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  live          Int      @default(0)
  resolved      Int      @default(0)
  open          Int      @default(0)
  in_progress   Int      @default(0)
  refreshed_at  DateTime @default(now()) @updatedAt
}

model Contact {
  id              String      @id @default(auto()) @map("_id") @db.ObjectId
  userId          String      @db.ObjectId
  contactUserId   String      @db.ObjectId
  createdAt       DateTime    @default(now())

  user            User        @relation("UserContacts", fields: [userId], references: [id], onDelete: Cascade)
  contactUser     User        @relation("UserContactOf", fields: [contactUserId], references: [id], onDelete: Cascade)

  @@unique([userId, contactUserId])
  @@index([userId])
  @@index([contactUserId])
}

model TicketHistory {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  ticketId     String   @db.ObjectId
  ticket       Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  changedById  String?  @db.ObjectId
  changedBy    User?    @relation("TicketHistoryChangedBy", fields: [changedById], references: [id], onDelete: SetNull)

  field        String
  oldValue     String?
  newValue     String?
  comment      String?
  createdAt    DateTime @default(now())

  @@index([ticketId])
  @@index([createdAt])
  @@index([changedById])
}

model AlertHistory {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  alertId      String   @db.ObjectId
  alert        Alert    @relation(fields: [alertId], references: [id], onDelete: Cascade)

  changedById  String?  @db.ObjectId
  changedBy    User?    @relation("AlertHistoryChangedBy", fields: [changedById], references: [id], onDelete: SetNull)

  field        String
  oldValue     String?
  newValue     String?
  comment      String?
  createdAt    DateTime @default(now())

  @@index([alertId])
  @@index([createdAt])
  @@index([changedById])
}